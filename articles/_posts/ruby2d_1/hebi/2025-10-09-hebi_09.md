---
layout: post
part: Ruby2D(1)
title: ヘビゲーム
categories: [ruby2d_1, hebi]
chapter: 1
section: 9
section_title: ヘビが成長するアイテムを作る
description: 最初のステップ。スクラッチの始め方を紹介します。
---

## {{ page.section_title }}

### アイテム管理の準備をする

時間経過によって丸いアイテムを出現させたり、消失させたりしたいので、変数　 `tick` を作り、1秒ごとに1/3の確率でアイテムを出現させる。

出現するアイテムは、変数 `items` で管理する。

main.rb
```
(略)
# すでに頭に当たっている2個目以降の胴体の数
touched_count = bodies[1, body_size - 1].select { |body| body.contains?(head.x, head.y) }.size

# 経過時間の管理
tick = 0

# アイテムの管理
items = []

def hit(head)
(略)

(略)
      body.y = logs[speed * i].last
    end

    tick += 1
    p items.size
  end
end

show
```

### 丸いアイテムを出現

main.rb
```
(略)
# 胴体の当たり判定
def touch(head, bodies, touched_count)
  current_touch_count = bodies[1, bodies.size - 1].select { |body| body.contains?(head.x, head.y) }.size
  current_touch_count > touched_count
end

# アイテムをランダムに出現させる
def add_item(items, tick)
  n = rand(0..1)
  if tick % 60 == 0 && n == 0
    items << [
      Circle.new(
        x: rand(10..Window.width - 10),
        y: rand(10..Window.height - 10),
        radius: 10,
        color: "green"
      ),
      tick
    ]
  end
end

on :key_down do |event|
(略)

(略)
      body.y = logs[speed * i].last
    end
    # アイテムの出現
    add_item(items, tick)
    
    tick += 1
    p items.size
  end
end

show
```

### ファイルの実行

bash
```
$ ruby main.rb
```

### 結果

緑の丸がランダムなタイミングで出現し、ターミナルにその数が表示される。

### 丸いアイテムがそれぞれ2秒で消失する。

main.rb
```
(略)
# アイテムをランダムに出現させる
def add_item(items, tick)
  n = rand(0..1)
  if tick % 60 == 0 && n == 0
    items << [
      Circle.new(
        x: rand(10..Window.width - 10),
        y: rand(10..Window.height - 10),
        radius: 10,
        color: "green"
      ),
      tick
    ]
  end
end

# アイテムを時間経過で消失させる
def remove_item(items, tick)
  items.each do |item|
    if tick - item.last >= 180
      item.first.remove
      items.delete(item)
    end
  end
end

on :key_down do |event|
(略)

(略)
    # アイテムの出現
    add_item(items, tick)
    # アイテムの消失
    remove_item(items, tick)

    tick += 1
    p items.size
  end
end

show
```

### ファイルの実行

bash
```
$ ruby main.rb
```

### 結果

緑の丸がランダムなタイミングで出現しそれぞれ２秒で消失する。
ターミナルにその数が表示される。

うまくいったらここで、

```
p items.size
```

は不要になるので、削除しておきます。

#### *ここで試したいこと

- 出現するタイミングを変更してみる。
- 消えるタイミングを変更してみる。

### ここまでのコード

main.rb
```
require "ruby2d"

# ヘビの頭
head = Circle.new(radius: 10)
head.x = Window.width / 2
head.y = Window.height / 2
speed = 3
x_flug = true
y_flug = false
status = :stop

# ヘビの胴体
body_size = 20
logs = (body_size * speed + 1).times.map { |i| [head.x - speed * i, head.y + speed * i] }
bodies = body_size.times.map { |i| Circle.new(radius: 8, x: logs[speed * i].first, y: logs[speed * i].last) }

# ゲームオーバー画面
message = [
  Text.new("GAME OVER", size: 30, x: 220, y: 150),
  Text.new("press key 'R' to restart", size: 20, x: 205, y: 300)
]
message.each { |text| text.remove }

# すでに頭に当たっている2個目以降の胴体の数
touched_count = bodies[1, body_size - 1].select { |body| body.contains?(head.x, head.y) }.size

# 経過時間の管理
tick = 0

# アイテムの管理
items = []

def hit(head)
  # 上の当たり判定
  top = head.contains?(head.x, 0)
  # 下の当たり判定
  bottom = head.contains?(head.x, Window.height)
  # 右の当たり判定
  right = head.contains?(Window.width, head.y)
  # 左の当たり判定
  left = head.contains?(0, head.y)
  top || bottom || right || left
end

# 胴体の当たり判定
def touch(head, bodies, touched_count)
  current_touch_count = bodies[1, bodies.size - 1].select { |body| body.contains?(head.x, head.y) }.size
  current_touch_count > touched_count
end

# アイテムをランダムに出現させる
def add_item(items, tick)
  n = rand(0..1)
  if tick % 60 == 0 && n == 0
    items << [
      Circle.new(
        x: rand(10..Window.width - 10),
        y: rand(10..Window.height - 10),
        radius: 10,
        color: "green"
      ),
      tick
    ]
  end
end

# アイテムを時間経過で消失させる
def remove_item(items, tick)
  items.each do |item|
    if tick - item.last >= 180
      item.first.remove
      items.delete(item)
    end
  end
end

on :key_down do |event|
  # ゲームスタート
  if event.key == "right" || event.key == "left"
    status = :game_start if status == :stop
  end
  # リスタート
  if event.key == "r" && status == :game_over
    status = :stop
    head.x = Window.width / 2
    head.y = Window.height / 2
    x_flug = true
    y_flug = false
    logs = (body_size * speed + 1).times.map { |i| [head.x - speed * i, head.y + speed * i] }
    bodies.each { |body| body.remove }
    bodies = body_size.times.map { |i| Circle.new(radius: 8, x: logs[speed * i].first, y: logs[speed * i].last) }
    message.each { |text| text.remove }
  end
  # 右上に移動の時
  if x_flug && !y_flug
    case event.key
    when "right"
      y_flug = true
    when "left"
      x_flug = false
    end
  # 左上に移動の時
  elsif !x_flug && !y_flug
    case event.key
    when "right"
      x_flug = true
    when "left"
      y_flug = true
    end
  # 右下に移動の時
  elsif x_flug && y_flug
    case event.key
    when "right"
      x_flug = false
    when "left"
      y_flug = false
    end
  # 左下に移動の時
  elsif !x_flug && y_flug
    case event.key
    when "right"
      y_flug = false
    when "left"
      x_flug = true
    end
  end
end

update do
  case status
  when :game_start
    # 当たり判定
    if hit(head) || touch(head, bodies, touched_count)
      status = :game_over
      message.each { |text| text.add }
    end
    # 移動方向の管理
    if x_flug
      head.x += speed
    else
      head.x -= speed
    end
    if y_flug
      head.y += speed
    else
      head.y -= speed
    end
    # logの更新
    logs.unshift([head.x, head.y])
    logs.pop
    # 胴体の更新
    bodies.each.with_index(1) do |body, i|
      body.x = logs[speed * i].first
      body.y = logs[speed * i].last
    end
    # アイテムの出現
    add_item(items, tick)
    # アイテムの消失
    remove_item(items, tick)

    tick += 1
  end
end

show
```